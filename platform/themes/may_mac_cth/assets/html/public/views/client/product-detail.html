<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm - May Mặc CTH</title>
    <link href="../../../../https@fonts.googleapis.com/css2@family=Archivo_3Awght_40400;600;700&display=swap" rel="stylesheet">
    <link href="../../../../https@fonts.googleapis.com/css2@family=Baloo+2_3Awght_40400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../../../../https@unpkg.com/boxicons_402.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/product-detail.css">
</head>

<body>
    <!-- Top Header -->
    <div class="top-header bg-white border-bottom">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="dropdown me-4">
                        <button class="btn btn-sm p-0 text-muted d-flex align-items-center" type="button"
                            aria-expanded="false">

                            <img src="../../assets/images/vietnam-flag.png" id="currentFlag"
                                style="width: 20px; height: 20px; object-fit: cover; border-radius: 3px;">
                            <span id="currentLang" class="ms-1">VN</span>
                        </button>

                        <!-- <ul class="dropdown-menu" aria-labelledby="languageDropdown" style="min-width: 120px;">
                            <li>
                                <a class="dropdown-item d-flex align-items-center choose-lang" data-lang="VN"
                                    data-flag="asset/images/vietnam-flag.png" href="#">
                                    <img src="asset/images/vietnam-flag.png"
                                        style="width: 22px; height: 22px; object-fit: cover; border-radius: 3px;">
                                    <span class="ms-2">VN</span>
                                </a>
                            </li>

                            <li>
                                <a class="dropdown-item d-flex align-items-center choose-lang" data-lang="EN"
                                    data-flag="asset/images/us-flag.png" href="#">
                                    <img src="asset/images/us-flag.png"
                                        style="width: 22px; height: 22px; object-fit: cover; border-radius: 3px;">
                                    <span class="ms-2">EN</span>
                                </a>
                            </li>
                        </ul> -->
                    </div>
                    <span class="text-muted me-3"></span>
                    <!-- <a href="tel:+0783157988" class="text-muted me-4">
                        <i class="bx bx-phone-call me-1"></i> 0783 157 988
                    </a> -->
                    <span class="text-muted me-4">
                        <i class="bx bx-phone-call me-1"></i> 0783 157 988
                    </span>
                </div>
                <!-- <a href="#" class="text-muted">
                    <i class="bx bx-git-compare me-1"></i> So sánh
                </a> -->
                <!--<span class="text-muted">-->
                <!--    <i class="bx bx-git-compare me-1"></i> So sánh-->
                <!--</span>-->
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar bg-white py-2">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between">

                <a href="index.html">
                    <img src="../../assets/images/logo.png" alt="Logo" height="60" class="me-32">
                </a>

                <div class="d-flex align-items-center bg-white border rounded px-2"
                    style="height: 45px; position: relative;">

                    <div class="search-dropdown-wrap h-100 d-flex align-items-center position-relative">
                        <input type="hidden" id="categorySelectValue" value="">

                        <div class="search-trigger d-flex align-items-center cursor-pointer pe-3 border-end"
                            style="cursor: pointer; min-width: 130px; justify-content: space-between; height: 100%;">
                            <span id="categoryDisplayText" class="fw-bold text-dark" style="font-size: 14px;">Tất
                                cả</span>
                            <i class='bx bx-chevron-down ms-2 text-muted'></i>
                        </div>

                        <ul class="search-dropdown-list" id="searchCategoryUl">
                            <li><a href="javascript:void(0)" onclick="selectSearchCategory('', 'Tất cả')">Tất cả</a>
                            </li>
                        </ul>
                    </div>

                    <div class="search-container flex-grow-1 ms-2 d-flex align-items-center">
                        <input type="text" class="form-control border-0 shadow-none search-input" id="searchInput"
                            placeholder="Tìm kiếm sản phẩm..." aria-label="Search" style="font-size: 14px;">
                        <button class="btn border-0" type="button" id="btnSearch">
                            <i class='bx bx-search fs-5 text-primary'></i>
                        </button>
                    </div>
                </div>

                <a href="tel_3A+0783157988" class="btn btn-outline-primary px-4">
                    <i class="bx bx-phone-call me-1"></i> 0783 157 988
                </a>
            </div>
        </div>
    </div>

    <!-- Menu -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto align-items-center">
                    <li class="nav-item dropdown-custom me-4">
                        <a href="#" class="nav-link text-warning d-flex align-items-center">
                            <i class="bx bx-menu me-2"></i> TẤT CẢ DANH MỤC
                        </a>
                        <ul class="dropdown-menu-custom">
                            <li><a href="#">Áo đồng phục</a></li>
                            <li><a href="#">Áo thể thao</a></li>
                            <li><a href="#">Áo + Logo áo</a></li>
                            <li><a href="#">BST + Logo áo</a></li>
                            <li><a href="#">Đồng phục công giáo</a></li>
                            <li><a href="#">Đồng phục công sở</a></li>
                            <li><a href="#">Đồng phục học tập</a></li>
                            <li><a href="#">Đồng phục mùa non</a></li>
                        </ul>
                    </li>

                    <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link" href="about-us.html">Về chúng tôi</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="products.html">Sản phẩm</a></li>
                    <li class="nav-item"><a class="nav-link" href="guide.html">Hướng dẫn</a></li>
                    <li class="nav-item dropdown-custom">
                        <a href="news.html" class="nav-link text-warning d-flex align-items-center">
                            Tin tức
                        </a>
                        <ul class="dropdown-menu-custom" id="newsCategoryDropdown">
                            <li class="text-center py-3"><small class="text-muted">Đang tải danh mục...</small></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Liên hệ</a></li>
                </ul>

                <ul class="navbar-nav ms-3">
                    <li class="nav-item" style="margin-right: 90px;">
                        <a class="nav-link" href="cart.html"
                            style="display: flex; align-items: center; justify-content: center;">

                            <div
                                style="position: relative; width: 24px !important; height: 24px !important; line-height: 24px;">

                                <i class="bx bx-cart" style="font-size: 24px; position: absolute; top: 0; left: 0;"></i>

                                <span id="cartCount" class="badge rounded-pill bg-danger"
                                    style="position: absolute; top: -6px; right: -8px; font-size: 9px; padding: 2px 4px; border: 2px solid #fff; display: none;">
                                    0
                                    <span class="visually-hidden">sản phẩm</span>
                                </span>
                            </div>

                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content: Product Detail Section -->
    <section class="product-detail">
        <div class="title-section">
            <div class="container d-flex justify-content-between align-items-center flex-wrap">
                <div class="page-title" id="categoryTitle">ĐANG TẢI...</div>
                <div class="breadcrumb-nav" id="breadcrumb">
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row align-items-start">
                <div class="col-12 col-md-6 mb-4 mb-md-0">
                    <div class="product-image">
                        <img src="" alt="Đang tải..." id="main-product-image" class="w-100"
                            style="background:#f5f5f5; min-height:400px; object-fit:contain;">

                        <div class="thumbnail-images mt-3 d-flex gap-2 flex-wrap" id="thumbnailContainer">
                        </div>
                    </div>

                    <div class="accordion product-info-accordion mt-4" id="productDetailsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseDetails">
                                    Chi tiết sản phẩm
                                </button>
                            </h2>
                            <div id="collapseDetails" class="accordion-collapse collapse">
                                <div class="accordion-body" id="productDescription">
                                    Đang tải mô tả...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="product-info">
                        <h1 class="product-title mb-0" id="productName">Đang tải sản phẩm...</h1>

                        <div class="price-range mb-4">
                            <span class="price h3 fw-bold text-danger" id="productPrice">0đ</span>
                        </div>

                        <div class="product-meta mb-4 text-muted small">
                            <div><strong>Mã sản phẩm:</strong> <span id="productSku">SP00</span></div>
                            <div><strong>Danh mục:</strong> <span id="productCategory">-</span></div>
                        </div>

                        <div class="color-options mb-4 text-start" id="colorOptions" style="display: none;">
                            <h6 class="fw-bold mb-2">Màu sắc</h6>
                            <div class="color-swatches d-flex gap-2" id="colorSwatches"></div>
                        </div>

                        <div class="size-options mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold mb-0">Kích thước</h6>
                                <a href="#" class="size-guide text-primary small">Hướng dẫn chọn size</a>
                            </div>
                            <div class="size-buttons d-flex gap-2" id="sizeButtons">
                                <button class="btn btn-outline-secondary btn-size active" data-size="M">M</button>
                            </div>
                        </div>

                        <div class="quantity mb-4">
                            <h6 class="fw-bold mb-2">Số lượng</h6>
                            <div class="input-group w-50">
                                <button class="btn btn-outline-secondary" type="button" id="decrease">-</button>
                                <input type="text" class="form-control text-center fw-bold" value="1" readonly
                                    id="quantityInput">
                                <button class="btn btn-outline-secondary" type="button" id="increase">+</button>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-add-cart" id="addToCartBtn">
                                Thêm vào giỏ hàng
                            </button>
                            <button class="btn btn-buy" id="orderBtn">
                                Mua ngay
                            </button>
                        </div>

                        <!-- <div class="product-description-wrapper mt-4 pt-3">
                            <div class="section-title-container">
                                <h2 class="section-title">Mô tả sản phẩm</h2>
                            </div>
                            <div class="product-description-content mt-3" id="shortDescription">
                                Đang tải...
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- size table -->
    <div class="modal fade" id="sizeGuideModal" tabindex="-1" aria-labelledby="sizeGuideLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sizeGuideLabel">HƯỚNG DẪN CHỌN SIZE</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="text-center">
                    <img src="../../assets/images/size-table.png" alt="Bảng size" class="img-fluid rounded shadow">
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <hr class="section-divider">
    </div>

    <!-- review -->
    <section class="product-reviews-section">
        <div class="container">
            <div class="reviews-header">
                <h2 class="reviews-main-title">Đánh giá sản phẩm</h2>
                <div class="overall-rating">
                    <span class="rating-score" id="avgRating">0.0</span>
                    <div class="rating-stars text-warning" id="avgStars">
                        <i class='bx bx-star'></i> 
                    </div>
                    <span class="review-count-text" id="reviewCountText">Dựa trên 0 khách hàng</span>
                </div>
                <div class="my-4">
                    <button class="btn btn-review px-4" data-bs-toggle="collapse" data-bs-target="#writeReviewCollapse">
                        <i class='bx bxs-edit-alt'></i> Viết đánh giá
                    </button>
                </div>
            </div>
            <div class="collapse mt-4" id="writeReviewCollapse">
                <div class="p-4 border rounded bg-light">
                    <h5 class="fw-bold mb-3">Viết đánh giá của bạn</h5>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Số điện thoại</label>
                        <input type="text" class="form-control" id="reviewPhone" placeholder="Nhập số điện thoại">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Họ tên</label>
                        <input type="text" class="form-control" id="reviewName" placeholder="Họ tên" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold d-block">Xếp hạng</label>
                        <div class="rating-stars-input" id="ratingStars">
                            <i class='bx bx-star' data-value="1"></i>
                            <i class='bx bx-star' data-value="2"></i>
                            <i class='bx bx-star' data-value="3"></i>
                            <i class='bx bx-star' data-value="4"></i>
                            <i class='bx bx-star' data-value="5"></i>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Kích thước bạn đã mua</label>
                        <select class="form-select" id="reviewSize">
                            <option value="">Chọn size</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Màu sắc</label>
                        <input type="text" class="form-control" id="reviewColor" placeholder="VD: Đen, Trắng, Đỏ,...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Nội dung đánh giá</label>
                        <textarea class="form-control" rows="4" id="reviewContent"
                            placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Chọn tag phù hợp với trải nghiệm của bạn <small
                                class="text-muted">(có thể chọn nhiều)</small></label>
                        <div class="review-tag-selection d-flex flex-wrap gap-2" id="reviewTagContainer">
                            <div class="text-center py-5 text-muted w-100">
                                <i class='bx bx-loader-alt bx-spin'></i> Đang tải tag...
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Thêm hình ảnh (tối đa 5)</label>
                        <input type="file" class="form-control" id="reviewImages" accept="image/*" multiple>
                        <div id="previewImages" class="d-flex gap-2 mt-2 flex-wrap"></div>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary px-4" id="submitReview">Gửi đánh giá</button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="collapse"
                            data-bs-target="#writeReviewCollapse">Hủy</button>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 col-lg-4">
                    <div class="review-filters">
                        <h6 class="filter-title">Lọc đánh giá</h6>
                        <div class="input-group search-reviews mb-4">
                            <span class="input-group-text"><i class='bx bx-search'></i></span>
                            <input type="text" class="form-control" id="searchReviewInput"
                                placeholder="Tìm kiếm đánh giá">
                        </div>

                        <h6 class="filter-title">Phân loại xếp hạng</h6>
                        <ul class="filter-list star-filter-list">
                            <li><button class="btn btn-filter-star" data-rating="5">5 <i
                                        class='bx bxs-star'></i></button></li>
                            <li><button class="btn btn-filter-star" data-rating="4">4 <i
                                        class='bx bxs-star'></i></button></li>
                            <li><button class="btn btn-filter-star" data-rating="3">3 <i
                                        class='bx bxs-star'></i></button></li>
                            <li><button class="btn btn-filter-star" data-rating="2">2 <i
                                        class='bx bxs-star'></i></button></li>
                            <li><button class="btn btn-filter-star" data-rating="1">1 <i
                                        class='bx bxs-star'></i></button></li>
                        </ul>
                    </div>
                </div>

                <div class="col-12 col-lg-8 mt-4 mt-lg-0">
                    <div class="review-list" id="reviewList">
                        <div class="text-center py-5" id="loadingReviews">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-3">Đang tải đánh giá...</p>
                        </div>
                        <div id="noReviews" class="text-center py-5 text-muted" style="display:none;">
                            Chưa có đánh giá nào cho sản phẩm này.
                        </div>
                    </div>

                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="reviewPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- <div id="addToCartToast" class="toast-notification">
        <div class="toast-icon">
            <i class="bx bx-check-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">Thêm vào giỏ hàng thành công!</div>
            <div class="toast-message" id="toastProductName">Sản phẩm XYZ</div>
        </div>
        <button class="toast-close">&times;</button>
    </div> -->

    <!-- Footer -->
    <footer class="footer bg-primary text-white py-5">
        <div class="container">
            <div class="row gy-4">
                <div class="col-12 col-md-6 col-lg-3">
                    <a href="index.html">
                        <img src="../../assets/images/logo2.png" alt="Logo" class="footer-logo mb-3">
                    </a>
                    <p class="footer-slogan">MAY MẶC CTH lắng nghe bạn !</p>
                    <p class="footer-desc mb-3">
                        Chúng tôi luôn quý trọng và tiếp thu mọi ý kiến đóng góp từ khách hàng.
                    </p>
                    <a href="contact.html#feedbackForm" class="btn btn-warning footer-btn mb-3">
                        ĐÓNG GÓP Ý KIẾN →
                    </a>
                    <p class="footer-tax"><strong>MÃ SỐ THUẾ:</strong> 0202167805</p>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="mb-4">
                        <p class="footer-title">VỀ CHÚNG TÔI</p>
                        <ul class="footer-links">
                            <li><a href="#">Giới thiệu MAY MẶC CTH</a></li>
                            <li><a href="#">Hướng dẫn mua hàng</a></li>
                            <li><a href="#">Hướng dẫn chọn size</a></li>
                            <li><a href="#">Chính sách đổi trả</a></li>
                            <li><a href="#">FAQ</a></li>
                        </ul>
                    </div>
                    <div>
                        <p class="footer-title mb-3">THÔNG TIN LIÊN HỆ</p>

                        <div class="d-flex align-items-start mb-3">
                            <i class='bx bx-map text-warning me-2'
                                style="font-size: 16px; min-width: 22px; margin-top: 3px;"></i>
                            <span id="footerAddress" style="font-size: 14px; color: #ffffffd9;">Đang tải địa
                                chỉ...</span>
                        </div>

                        <div class="d-flex align-items-start mb-3">
                            <i class='bx bx-globe text-success me-2'
                                style="font-size: 16px; min-width: 22px; margin-top: 3px;"></i>
                            <span id="footerWebsite" style="font-size: 14px; color: #ffffffd9;">Đang tải
                                website...</span>
                        </div>

                        <div class="d-flex align-items-start mb-4">
                            <i class='bx bx-phone text-danger me-2'
                                style="font-size: 16px; min-width: 22px; margin-top: 3px;"></i>
                            <span id="footerPhone" style="font-size: 14px; color: #ffffffd9;">Đang tải số điện
                                thoại...</span>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <div class="row">
                        <div class="col-6">
                            <p class="footer-title">SẢN PHẨM</p>
                            <ul class="footer-links" id="footerProductsCategories">
                                <li class="text-muted small">Đang tải...</li>
                            </ul>
                        </div>

                        <div class="col-6">
                            <div class="mb-4">
                                <p class="footer-title">TIN TỨC</p>
                                <ul class="footer-links" id="footerNewsCategories">
                                    <li class="text-muted small">Đang tải...</li>
                                </ul>
                            </div>
                            <div class="mb-4">
                                <p class="footer-title">PHƯƠNG THỨC THANH TOÁN</p>
                                <div class="d-flex gap-2">
                                    <img src="../../assets/images/cash.png" height="28" style="margin-right: 10px;">
                                    <img src="../../assets/images/mastercard.png" height="28"
                                        style="margin-right: 10px;">
                                    <img src="../../assets/images/visa.png" height="28">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="footer-contact-btns mt-4">
                        <a href="../../../../https@zalo.me/0783159798" target="_blank" class="contact-btn">
                            <div class="icon-wrap">
                                <img src="../../assets/images/zalo.png" alt="Zalo">
                            </div>
                            <div class="text-wrap">
                                <span class="contact-label">TƯ VẤN QUA</span>
                                <span class="contact-value">0783159798</span>
                            </div>
                        </a>

                        <a href="tel_3A0783159798" class="contact-btn">
                            <div class="icon-wrap">
                                <img src="../../assets/images/hotline.png" alt="Hotline">
                            </div>
                            <div class="text-wrap">
                                <span class="contact-label">HOTLINE TƯ VẤN</span>
                                <span class="contact-value">0783159798</span>
                            </div>
                        </a>

                        <a href="#" class="contact-btn">
                            <div class="icon-wrap">
                                <img src="../../assets/images/hotline.png" alt="Xem mẫu">
                            </div>
                            <div class="text-wrap">
                                <span class="contact-label">XEM VẢI & MẪU</span>
                                <span class="contact-value">0783159798</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <div id="globalToast" class="global-toast">
        <i id="toastIcon" class='bx'></i>
        <span id="toastMessage">Thông báo</span>
    </div>
    <!-- JavaScript -->
    <script src="../../../../https@cdn.jsdelivr.net/npm/bootstrap_405.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const BASE_URL = '../../../MayMacCTH';
            let uploadedImageNames = [];
            async function loadReviewTags() {
                const container = document.getElementById('reviewTagContainer');
                if (!container) return;

                try {
                    const res = await fetch(`https://demo9.sibic.vn/api/review_tags/get_review_tags.php`);
                    const result = await res.json();

                    if (result.success && result.data?.length > 0) {
                        const activeTags = result.data.filter(t => t.is_active == 1);
                        container.innerHTML = '';
                        activeTags.forEach(tag => {
                            const btn = document.createElement('div');
                            btn.className = 'tag-select';
                            btn.textContent = tag.content;
                            btn.dataset.tagId = tag.review_tag_id;
                            btn.onclick = () => btn.classList.toggle('selected');
                            container.appendChild(btn);
                        });
                    } else {
                        container.innerHTML = '<div class="text-muted">Chưa có tag nào.</div>';
                    }
                } catch (err) {
                    console.error(err);
                    container.innerHTML = '<div class="text-danger">Lỗi tải tag!</div>';
                }
            }
            await loadReviewTags();

            const previewContainer = document.getElementById('previewImages');
            document.getElementById('reviewImages')?.addEventListener('change', e => {
                const files = e.target.files;
                uploadedImageNames = [];
                previewContainer.innerHTML = '';

                if (files.length > 5) {
                    alert('Tối đa 5 ảnh thôi nhé!');
                    e.target.value = '';
                    return;
                }

                Array.from(files).forEach((file, i) => {
                    if (!file.type.startsWith('image/')) return;

                    const fileName = `review_${Date.now()}_${i}_${file.name}`;
                    uploadedImageNames.push(fileName);

                    const reader = new FileReader();
                    reader.onload = ev => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'position-relative me-2 mb-2';

                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        img.style.cssText = 'width:100px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #ddd;';

                        const remove = document.createElement('button');
                        remove.innerHTML = '×';
                        remove.style.cssText = 'position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,0.7);color:white;border:none;font-size:18px;cursor:pointer;';
                        remove.onclick = () => {
                            uploadedImageNames = uploadedImageNames.filter(n => n !== fileName);
                            wrapper.remove();
                        };

                        wrapper.appendChild(img);
                        wrapper.appendChild(remove);
                        previewContainer.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });
            });

            updateCartCount();

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const contentContainer = document.querySelector('.product-detail > .container');

            contentContainer.innerHTML = '<div class="text-center py-5"><h1>Đang tải sản phẩm...</h1></div>';

            if (!productId || isNaN(productId)) {
                contentContainer.innerHTML = '<div class="text-center py-5"><h1 class="text-danger">ID không hợp lệ!</h1></div>';
                return;
            }

            try {
                const res = await fetch(`https://demo9.sibic.vn/api/product/get_all_product.php`);
                if (!res.ok) throw new Error('Lỗi server');
                const result = await res.json();
                if (!result.success || !result.data?.length) throw new Error('Không có sản phẩm');

                const p = result.data.find(item => item.product_id == productId);
                if (!p) throw new Error('Sản phẩm không tồn tại');

                const categoryTitleEl = document.getElementById('categoryTitle');
                const breadcrumbEl = document.getElementById('productNameBreadcrumb');
                if (categoryTitleEl) categoryTitleEl.textContent = p.category_name || 'SẢN PHẨM';
                if (breadcrumb) {
                    breadcrumb.innerHTML = `
                        <a href="index.html">Trang chủ</a>
                        <span class="sep"> > </span>
                        <a href="products.html">Sản phẩm</a>
                        <span class="sep"> > </span>
                        <span class="current">${p.name}</span>
                    `;
                }

                contentContainer.innerHTML = `
                    <div class="row align-items-start">
                        <!-- Ảnh sản phẩm -->
                        <div class="col-12 col-md-6 mb-4 mb-md-0">
                            <div class="product-image">
                                <img src="" alt="${p.name}" id="main-product-image" class="w-100"
                                    style="min-height:400px; object-fit:contain;">
                                <div class="thumbnail-images mt-3 d-flex gap-2 flex-wrap" id="thumbnailContainer"></div>
                            </div>

                            <div class="accordion product-info-accordion mt-4">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapseDetails">
                                            Chi tiết sản phẩm
                                        </button>
                                    </h2>
                                    <div id="collapseDetails" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            ${p.description ? p.description.replace(/\n/g, '<br>') : 'Chưa có mô tả chi tiết.'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="product-info">
                                <h1 class="product-title mb-0 text-start">${p.name}</h1>
                                <div class="price-range mb-4 text-start">
                                    <span class="price h3 fw-bold">
                                        ${parseInt(p.price || 0).toLocaleString('vi-VN')}đ
                                    </span>
                                </div>
                                <!--
                                <div class="product-meta mb-4 text-muted small">
                                    <div><strong>Mã sản phẩm:</strong> SP${String(p.product_id).padStart(4, '0')}</div>
                                    <div><strong>Danh mục:</strong> ${p.category_name || 'Chưa xác định'}</div>
                                </div>
                                -->

                                ${p.colors && p.colors.length ? `
                                    <div class="color-options mb-4 text-start" id="colorOptions" style="display: none;">
                                        <h6 class="fw-bold mb-2">Màu sắc</h6>
                                        
                                        <div class="color-swatches d-inline-flex flex-wrap gap-2 p-2 rounded" 
                                            id="colorSwatches" 
                                            style="background-color: #fffaf0;">
                                            </div>
                                    </div>` : ''
                                }
                                <div class="size-options mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="fw-bold mb-0">Kích thước</h6>
                                        <a href="#" class="size-guide text-primary small">Hướng dẫn chọn size</a>
                                    </div>
                                    <div class="size-buttons d-flex gap-2 flex-wrap" id="sizeButtons"></div>
                                </div>

                                <div class="quantity mb-4">
                                    <h6 class="fw-bold mb-2 text-start">Số lượng</h6>
                                    <div class="input-group quantity-group">
                                        <button class="btn btn-outline-secondary" type="button" id="decrease">-</button>
                                        <input type="text" class="form-control fw-bold" value="1" readonly id="quantityInput">
                                        <button class="btn btn-outline-secondary" type="button" id="increase">+</button>
                                    </div>
                                </div>

                                <div class="action-buttons mb-3">
                                    <button class="btn btn-add-cart" id="addToCartBtn">Thêm vào giỏ hàng</button>
                                    <button class="btn btn-buy" id="orderBtn">Mua ngay</button>
                                </div>

                                <div class="product-meta mb-4 text-muted small text-start">
                                    <div><strong>Mã sản phẩm:</strong> SP${String(p.product_id).padStart(4, '0')}</div>
                                    <div><strong>Danh mục:</strong> ${p.category_name || 'Chưa xác định'}</div>
                                </div>

                                <div class="product-description-wrapper mt-4 pt-3 border-bottom">
                                    <h2 class="section-title text-start">Dịch vụ của chúng tôi</h2>
                                </div>

                                <div class="policy-wrapper mt-3">
                                    <div class="row g-4">
                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box text-box">
                                                    <span>FREE</span>
                                                    <span>SHIP</span>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">Free ship cho đơn trên 200k</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box">
                                                    <i class='bx bx-sync'></i>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">30 ngày đổi trả cho bất kì thứ gì</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box">
                                                    <i class='bx bx-phone-call'></i>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">Hotline hỗ trợ 0783159798</span>
                                                    <span class="policy-sub">hỗ trợ từ 8h30 - 22h</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box">
                                                    <i class='bx bx-map-pin'></i>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">Đến tận nơi nhận trả hàng</span>
                                                    <span class="policy-sub">hoàn tiền trong 24h</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const mainImg = document.getElementById('main-product-image');
                const thumbContainer = document.getElementById('thumbnailContainer');
                thumbContainer.innerHTML = '';

                let allImages = [];
                if (p.images && Array.isArray(p.images)) {
                    allImages = p.images.map(i => typeof i === 'object' ? i.image : i).filter(Boolean);
                }
                if (!allImages.length && p.primary_image) allImages.push(p.primary_image);
                if (!allImages.length) allImages.push('no-image.jpg');

                allImages.forEach((img, i) => {
                    const src = `../../assets/images/upload/${img}`;
                    if (i === 0) mainImg.src = src;

                    const thumb = document.createElement('img');
                    thumb.src = src;
                    thumb.alt = p.name;
                    thumb.className = 'thumbnail';
                    thumb.style.cssText = 'width:80px;height:80px;object-fit:cover;cursor:pointer;border:2px solid #eee;border-radius:8px;';
                    if (i === 0) thumb.classList.add('active');
                    thumb.onclick = () => {
                        mainImg.src = src;
                        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                    };
                    thumbContainer.appendChild(thumb);
                });

                if (p.colors && p.colors.length) {
                    document.getElementById('colorOptions').style.display = 'block';
                    const colorSwatches = document.getElementById('colorSwatches');
                    colorSwatches.innerHTML = ''; 

                    p.colors.forEach((color, idx) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-color-circle position-relative'; 
                        
                        btn.style.backgroundColor = color.color_code || '#ccc';
                        btn.title = color.color_name; 

                        if (idx === 0) btn.classList.add('active');

                        btn.onclick = () => {
                            colorSwatches.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            updateSizes(color.sizes || []);
                        };
                        colorSwatches.appendChild(btn);
                    });
                    
                    updateSizes(p.colors[0].sizes || []);
                } else {
                    document.getElementById('colorOptions').style.display = 'none';
                    document.getElementById('sizeButtons').innerHTML = '<span class="text-muted">Không có size</span>';
                }

                function updateSizes(sizes) {
                    const sizeButtons = document.getElementById('sizeButtons');
                    sizeButtons.innerHTML = '';
                    if (!sizes?.length) {
                        sizeButtons.innerHTML = '<span class="text-muted">Không có size</span>';
                        return;
                    }
                    sizes.forEach((size, idx) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-secondary btn-size';
                        btn.textContent = size;
                        if (idx === 0) btn.classList.add('active');
                        btn.onclick = () => {
                            sizeButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                        };
                        sizeButtons.appendChild(btn);
                    });
                }

                document.getElementById('increase')?.addEventListener('click', () => {
                    const input = document.getElementById('quantityInput');
                    input.value = parseInt(input.value) + 1;
                });
                document.getElementById('decrease')?.addEventListener('click', () => {
                    const input = document.getElementById('quantityInput');
                    if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
                });
                document.getElementById('addToCartBtn')?.addEventListener('click', function () {
                    const selectedColorBtn = document.querySelector('#colorSwatches .btn.active');
                    const selectedSizeBtn = document.querySelector('#sizeButtons .btn-size.active');
                    const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

                    if (p.colors && p.colors.length && !selectedColorBtn) {
                        alert('Vui lòng chọn màu sắc!');
                        return;
                    }
                    if (!selectedSizeBtn) {
                        alert('Vui lòng chọn kích thước!');
                        return;
                    }

                    const colorName = selectedColorBtn ? selectedColorBtn.title : 'Không có màu';
                    const size = selectedSizeBtn ? selectedSizeBtn.dataset.size || selectedSizeBtn.textContent : 'Freesize';
                    const price = parseInt(p.price || 0);
                    const image = document.getElementById('main-product-image').src;

                    const cartItem = {
                        id: p.product_id,
                        name: p.name,
                        price: price,
                        quantity: quantity,
                        color: colorName,
                        size: size,
                        image: image.includes('upload/') ? image.split('/').pop() : 'no-image.jpg',
                        uniqueKey: `${p.product_id}-${colorName}-${size}`
                    };

                    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                    const existingIndex = cart.findIndex(item => item.uniqueKey === cartItem.uniqueKey);

                    if (existingIndex !== -1) {
                        cart[existingIndex].quantity += quantity;
                        showToast(`Đã cập nhật số lượng: ${p.name} (${colorName}, ${size})`, 'success');
                    } else {
                        cart.push(cartItem);
                        showToast(`Đã thêm vào giỏ hàng: ${p.name}`, 'success');
                    }
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount();
                });
                document.getElementById('orderBtn')?.addEventListener('click', function () {
                    const selectedColorBtn = document.querySelector('#colorSwatches .btn.active');
                    const selectedSizeBtn = document.querySelector('#sizeButtons .btn-size.active');
                    const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

                    if (p.colors && p.colors.length && !selectedColorBtn) {
                        showToast('Vui lòng chọn màu sắc!', 'error');
                        return;
                    }
                    if (!selectedSizeBtn) {
                        showToast('Vui lòng chọn kích thước!', 'error');
                        return;
                    }

                    const colorName = selectedColorBtn ? selectedColorBtn.title : null;
                    const size = selectedSizeBtn ? selectedSizeBtn.textContent : 'Freesize';
                    const price = parseInt(p.price || 0);
                    const image = document.getElementById('main-product-image').src.split('/').pop();

                    const buyNowItem = {
                        id: p.product_id,
                        name: p.name,
                        price: price,
                        quantity: quantity,
                        color: colorName,
                        size: size,
                        image: image || 'no-image.jpg',
                        uniqueKey: `${p.product_id}-${colorName || 'no-color'}-${size}`
                    };

                    localStorage.setItem('buy_now_item', JSON.stringify([buyNowItem]));
                    window.location.href = 'order.html@type=buy_now';
                });
                document.querySelector('.size-guide')?.addEventListener('click', e => {
                    e.preventDefault();
                    new bootstrap.Modal(document.getElementById('sizeGuideModal')).show();
                });

                document.title = `${p.name} - May Mặc CTH`;

            } catch (err) {
                console.error(err);
                contentContainer.innerHTML = `<div class="text-center py-5"><h1 class="text-danger">Lỗi tải sản phẩm</h1><p>${err.message}</p><button class="btn btn-primary" onclick="location.reload()">Tải lại</button></div>`;
            }

            // const addressEl = document.getElementById('footerAddress');
            // const websiteEl = document.getElementById('footerWebsite');
            // const phoneEl = document.getElementById('footerPhone');

            // if (!addressEl && !websiteEl && !phoneEl) return;

            // try {
            //     const res = await fetch(`https://demo9.sibic.vn/api/contact/get_contact.php?t=${Date.now()}`);
            //     const data = await res.json();

            //     if (data.success && data.data && data.data.length > 0) {
            //         const c = data.data[0];

            //         if (addressEl) {
            //             addressEl.textContent = c.address || 'Chưa cập nhật địa chỉ';
            //         }

            //         if (websiteEl) {
            //             if (c.website && c.website.trim()) {
            //                 const url = c.website.match(/^https?:\/\//i) ? c.website : '../../../../https@/' + c.website;
            //                 websiteEl.outerHTML = `<a href="${url}" target="_blank" class="text-white text-decoration-none">${c.website}</a>`;
            //             } else {
            //                 websiteEl.textContent = 'Chưa có website';
            //             }
            //         }

            //         if (phoneEl) {
            //             phoneEl.textContent = c.phone_number || 'Chưa cập nhật số điện thoại';
            //         }
            //     }
            // } catch (err) {
            //     console.error('Lỗi load footer contact:', err);
            // }

            document.getElementById('writeReviewCollapse')?.addEventListener('shown.bs.collapse', function () {
                const stars = document.querySelectorAll('#ratingStars i');
                let selectedRating = 0;

                stars.forEach(s => {
                    s.className = 'bx bx-star';
                    s.style.color = '#ccc';
                });

                stars.forEach((star, idx) => {
                    star.style.cursor = 'pointer';

                    star.onmouseover = () => {
                        stars.forEach((s, i) => {
                            if (i <= idx) {
                                s.className = 'bx bxs-star';
                                s.style.color = '#f39c12';
                            } else {
                                s.className = 'bx bx-star';
                                s.style.color = '#ccc';
                            }
                        });
                    };

                    star.onclick = () => {
                        selectedRating = idx + 1;
                        stars.forEach((s, i) => {
                            if (i <= idx) {
                                s.className = 'bx bxs-star';
                                s.style.color = '#f39c12';
                            } else {
                                s.className = 'bx bx-star';
                                s.style.color = '#ccc';
                            }
                        });
                    };
                });

                document.getElementById('ratingStars').onmouseleave = () => {
                    if (selectedRating === 0) {
                        stars.forEach(s => {
                            s.className = 'bx bx-star';
                            s.style.color = '#ccc';
                        });
                    }
                };

                document.getElementById('reviewPhone')?.focus();
            });

            const reviewPhoneInput = document.getElementById('reviewPhone');
            const reviewNameInput = document.getElementById('reviewName');
            const submitReviewBtn = document.getElementById('submitReview');

            if (submitReviewBtn) submitReviewBtn.disabled = true;

            const phoneHelp = document.createElement('small');
            phoneHelp.id = 'phoneReviewHelp';
            phoneHelp.className = 'text-muted d-block mt-1';
            reviewPhoneInput?.parentNode.appendChild(phoneHelp);

            reviewPhoneInput?.addEventListener('input', async function () {
                const phone = this.value.trim();
                phoneHelp.textContent = '';
                phoneHelp.className = 'text-muted d-block mt-1';

                if (phone.length < 9) {
                    submitReviewBtn.disabled = true;
                    phoneHelp.textContent = 'Vui lòng nhập số điện thoại hợp lệ';
                    phoneHelp.className = 'text-danger';
                    reviewNameInput.value = '';
                    reviewNameInput.readOnly = false;
                    return;
                }

                let cleanPhone = phone.replace(/\D/g, '');
                if (cleanPhone.startsWith('84')) {
                    cleanPhone = '0' + cleanPhone.slice(2);
                }

                const productId = new URLSearchParams(window.location.search).get('id');

                try {
                    phoneHelp.textContent = 'Đang kiểm tra...';
                    phoneHelp.className = 'text-primary';

                    const res = await fetch(`${BASE_URL}/api/review_products/check_review_permission.php?phone=${encodeURIComponent(cleanPhone)}&product_id=${productId}&t=${Date.now()}`);
                    const data = await res.json();

                    if (data.can_review) {
                        reviewNameInput.value = data.customer_name || 'Khách hàng';
                        reviewNameInput.readOnly = true;
                        submitReviewBtn.disabled = false;
                        phoneHelp.textContent = 'Cảm ơn bạn đã tin tưởng và ủng hộ – Hãy để lại cho chúng tôi 1 đánh giá!';
                        phoneHelp.className = 'text-success fw-bold';
                    } else {
                        reviewNameInput.value = '';
                        reviewNameInput.readOnly = false;
                        submitReviewBtn.disabled = true;
                        phoneHelp.textContent = data.message || 'Bạn chưa mua sản phẩm này hoặc đơn chưa hoàn tất';
                        phoneHelp.className = 'text-danger';
                    }
                } catch (err) {
                    console.error('Lỗi kiểm tra quyền đánh giá:', err);
                    phoneHelp.textContent = 'Lỗi kết nối, vui lòng thử lại';
                    phoneHelp.className = 'text-danger';
                    submitReviewBtn.disabled = true;
                }
            });

            document.getElementById('submitReview')?.addEventListener('click', async () => {
                const name = document.getElementById('reviewName')?.value.trim();
                const phone = document.getElementById('reviewPhone')?.value.trim();
                const content = document.getElementById('reviewContent')?.value.trim();
                const rating = document.querySelectorAll('#ratingStars i.bxs-star').length;
                const size = document.getElementById('reviewSize')?.value || '';
                const color = document.getElementById('reviewColor')?.value.trim() || '';
                const files = document.getElementById('reviewImages')?.files;

                if (!name || !phone || rating === 0 || !content) {
                    showToast('Vui lòng điền đầy đủ: Họ tên, SĐT, đánh giá sao và nội dung!', 'error');
                    return;
                }

                const tagIds = Array.from(document.querySelectorAll('#reviewTagContainer .tag-select.selected'))
                    .map(t => t.dataset.tagId);

                const formData = new FormData();
                formData.append('product_id', new URLSearchParams(window.location.search).get('id'));
                formData.append('customer_name', name);
                formData.append('phone', phone);
                formData.append('rating', rating);
                formData.append('size', size);
                formData.append('color', color);
                formData.append('content', content);
                tagIds.forEach(id => formData.append('tag_ids[]', id));

                if (files && files.length > 0) {
                    for (let file of files) {
                        formData.append('images[]', file);
                    }
                }

                try {
                    const res = await fetch(`${BASE_URL}/api/review_products/create_review.php`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await res.json();
                    showSuccessToast(result.message || (result.success ? 'Gửi đánh giá thành công!' : 'Có lỗi!'));

                    if (result.success) {
                        document.getElementById('reviewName').value = '';
                        document.getElementById('reviewPhone').value = '';
                        document.getElementById('reviewContent').value = '';
                        document.getElementById('reviewSize').selectedIndex = 0;
                        document.getElementById('reviewColor').value = '';
                        document.querySelectorAll('#ratingStars i').forEach(s => {
                            s.className = 'bx bx-star';
                            s.style.color = '#ccc';
                        });
                        document.getElementById('previewImages').innerHTML = '';
                        document.getElementById('reviewImages').value = '';
                        document.querySelectorAll('#reviewTagContainer .tag-select.selected')
                            .forEach(t => t.classList.remove('selected'));

                        bootstrap.Collapse.getInstance(document.getElementById('writeReviewCollapse'))?.hide();

                        function renderClientPagination(totalItems, totalPages, currentPage) {
                            const pagination = document.getElementById('reviewPagination');
                            pagination.dataset.currentPage = currentPage;

                            if (totalPages <= 1) {
                                pagination.innerHTML = '';
                                return;
                            }

                            let html = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                                <a class="page-link" href="#" data-page="${currentPage - 1}">Trước</a>
                            </li>`;

                            for (let i = 1; i <= totalPages; i++) {
                                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>`;
                            }

                            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                                <a class="page-link" href="#" data-page="${currentPage + 1}">Sau</a>
                            </li>`;
                            pagination.innerHTML = html;
                        }

                        document.getElementById('reviewPagination')?.addEventListener('click', e => {
                            e.preventDefault();
                            const link = e.target.closest('a');
                            if (!link || link.parentElement.classList.contains('disabled')) return;
                            const page = parseInt(link.dataset.page);
                            if (page > 0) {
                                document.getElementById('reviewPagination').dataset.currentPage = page;
                                renderFilteredReviews();
                                document.querySelector('.review-list')?.scrollIntoView({ behavior: 'smooth' });
                            }
                        });

                        document.getElementById('searchReviewInput')?.addEventListener('input', () => {
                            document.getElementById('reviewPagination').dataset.currentPage = 1;
                            renderFilteredReviews();
                        });

                        // document.querySelectorAll('.btn-filter-star').forEach(btn => {
                        //     btn.addEventListener('click', function () {
                        //         if (this.classList.contains('active')) {
                        //             this.classList.remove('active');
                        //         } else {
                        //             document.querySelectorAll('.btn-filter-star').forEach(b => b.classList.remove('active'));
                        //             this.classList.add('active');
                        //         }
                        //         document.getElementById('reviewPagination').dataset.currentPage = 1;
                        //         renderFilteredReviews();
                        //     });
                        // });
                        loadReviews(1);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Lỗi kết nối server!');
                }
            });

            async function loadReviews(page = 1) {
                const productId = new URLSearchParams(window.location.search).get('id');
                const reviewList = document.getElementById('reviewList');
                const loading = document.getElementById('loadingReviews');
                const noReviews = document.getElementById('noReviews');

                if (!productId) return;

                if (loading) loading.style.display = 'block';
                if (noReviews) noReviews.style.display = 'none';
                reviewList.innerHTML = '';

                try {
                    const res = await fetch(`https://demo9.sibic.vn/api/review_products/get_reviews.php?id=${productId}&limit=999`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const result = await res.json();

                    if (result.success && result.data) {
                        renderAverageRating(result.data.average_rating || 0, result.data.total_reviews || 0);
                        currentReviews = result.data.reviews.map(r => ({ ...r }));

                        document.querySelectorAll('.btn-filter-star').forEach(btn => {
                            btn.replaceWith(btn.cloneNode(true));
                        });

                        document.querySelectorAll('.btn-filter-star').forEach(btn => {
                            btn.addEventListener('click', function (e) {
                                e.preventDefault();
                                if (this.classList.contains('active')) {
                                    this.classList.remove('active');
                                } else {
                                    document.querySelectorAll('.btn-filter-star').forEach(b => b.classList.remove('active'));
                                    this.classList.add('active');
                                }
                                document.getElementById('reviewPagination').dataset.currentPage = 1;
                                renderFilteredReviews();
                            });
                        });
                        renderFilteredReviews();
                    } else {
                        reviewList.innerHTML = '<div class="text-center text-muted py-5">Chưa có đánh giá nào.</div>';
                        document.getElementById('reviewPagination').innerHTML = '';
                        if (noReviews) noReviews.style.display = 'block';
                    }
                } catch (err) {
                    console.error('Lỗi loadReviews:', err);
                    reviewList.innerHTML = '<div class="text-danger text-center py-4">Lỗi tải đánh giá!</div>';
                } finally {
                    if (loading) loading.style.display = 'none';
                }
            }
            function renderAverageRating(avg, total) {
                const scoreEl = document.getElementById('avgRating');
                const starsEl = document.getElementById('avgStars');
                const countEl = document.getElementById('reviewCountText');

                if (!scoreEl || !starsEl || !countEl) return;

                scoreEl.textContent = Number(avg).toFixed(1);
                starsEl.innerHTML = `<i class='bx bxs-star' style="font-size:1.5rem;"></i>`;

                if (total > 0) {
                    countEl.textContent = `Dựa trên ${total} khách hàng`;
                } else {
                    countEl.textContent = 'Chưa có đánh giá';
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            loadReviews(1);

            let currentReviews = [];  

            function renderFilteredReviews() {
                const searchText = (document.getElementById('searchReviewInput')?.value || '').trim().toLowerCase();
                const activeStarBtn = document.querySelector('.btn-filter-star.active');
                const selectedRating = activeStarBtn ? parseInt(activeStarBtn.dataset.rating) : null;

                let filtered = currentReviews.filter(review => {
                    const matchSearch = !searchText ||
                        (review.customer_name || '').toLowerCase().includes(searchText) ||
                        (review.content || '').toLowerCase().includes(searchText) ||
                        (review.size || '').toLowerCase().includes(searchText) ||
                        (review.color || '').toLowerCase().includes(searchText);

                    const matchRating = selectedRating === null || review.rating === selectedRating;

                    return matchSearch && matchRating;
                });

                const reviewList = document.getElementById('reviewList');
                const pagination = document.getElementById('reviewPagination');

                if (filtered.length === 0) {
                    reviewList.innerHTML = '<div class="text-center text-muted py-5">Không tìm thấy đánh giá nào phù hợp.</div>';
                    pagination.innerHTML = '';
                    return;
                }
                const perPage = 3;
                const totalPages = Math.ceil(filtered.length / perPage);
                let currentPage = parseInt(pagination.dataset.currentPage || '1');
                if (currentPage < 1 || currentPage > totalPages) currentPage = 1;

                const start = (currentPage - 1) * perPage;
                const end = start + perPage;
                const pageItems = filtered.slice(start, end);

                reviewList.innerHTML = pageItems.map(r => `
                    <div class="review-item border-bottom pb-4 mb-4">
                        <!-- Tên khách + ngày đẩy ra 2 bên -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${escapeHtml(r.customer_name || 'Khách hàng')}</strong>
                            <span class="text-muted small">${r.created_at || ''}</span>
                        </div>

                        <div class="text-warning mb-2">
                            ${Array(5).fill(0).map((_, i) =>
                    `<i class='bx ${i < (r.rating || 0) ? 'bxs-star' : 'bx-star'}'></i>`
                ).join('')}
                        </div>

                        ${r.size || r.color ? `
                        <div class="text-muted small mb-2">
                            ${r.size ? `Kích thước: ${escapeHtml(r.size)}` : ''}
                            ${r.size && r.color ? `&nbsp;&nbsp;|&nbsp;&nbsp;` : ''}
                            ${r.color ? `Màu: ${escapeHtml(r.color)}` : ''}
                        </div>` : ''}

                        <p class="mb-3">${escapeHtml(r.content || '')}</p>

                        ${r.images && r.images.length ? `
                        <div class="review-images d-flex gap-2 flex-wrap mb-3">
                            ${r.images.map(img => `
                                <img src="../../../public/assets/images/upload/${img}" 
                                    class="rounded border" style="width:100px;height:100px;object-fit:cover;cursor:pointer;"
                                    onclick="openImageModal('${BASE_URL}/public/assets/images/upload/${img}')">
                            `).join('')}
                        </div>` : ''}

                        ${r.tags && r.tags.length ? `
                        <div class="d-flex gap-2 flex-wrap">
                            ${r.tags.map(tag => `<span class="badge bg-light text-dark border">${escapeHtml(tag)}</span>`).join('')}
                        </div>` : ''}
                    </div>
                `).join('');

                renderClientPagination(filtered.length, totalPages, currentPage);
            }

            function renderClientPagination(totalItems, totalPages, currentPage) {
                const pagination = document.getElementById('reviewPagination');
                pagination.dataset.currentPage = currentPage;

                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Trước</a>
                </li>`;

                for (let i = 1; i <= totalPages; i++) {
                    html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>`;
                }

                html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Sau</a>
                </li>`;

                pagination.innerHTML = html;
            }

            document.getElementById('reviewPagination')?.addEventListener('click', e => {
                e.preventDefault();
                const link = e.target.closest('a');
                if (!link || link.parentElement.classList.contains('disabled')) return;
                const page = parseInt(link.dataset.page);
                if (page > 0) {
                    const pagination = document.getElementById('reviewPagination');
                    pagination.dataset.currentPage = page;
                    renderFilteredReviews();
                    document.querySelector('.review-list')?.scrollIntoView({ behavior: 'smooth' });
                }
            });

            document.getElementById('searchReviewInput')?.addEventListener('input', () => {
                renderFilteredReviews();
            });

            // Lọc theo sao
            // document.querySelectorAll('.btn-filter-star').forEach(btn => {
            //     btn.addEventListener('click', function () {
            //         document.querySelectorAll('.btn-filter-star').forEach(b => b.classList.remove('active'));
            //         this.classList.add('active');
            //         renderFilteredReviews();
            //     });
            // });

            const dropdownMenu = document.querySelector('.dropdown-menu-custom');

            if (!dropdownMenu) return;

            dropdownMenu.innerHTML = '';

            try {
                const response = await fetch('../../../api/category/get_category.php@t=' + Date.now());

                if (!response.ok) {
                    throw new Error('Lỗi mạng: ' + response.status);
                }

                const result = await response.json();

                if (!result.success || !Array.isArray(result.data) || result.data.length === 0) {
                    dropdownMenu.innerHTML = '<li><a href="#" class="dropdown-item text-muted">Chưa có danh mục</a></li>';
                    return;
                }

                const activeCategories = result.data.filter(cat =>
                    cat.is_active === undefined || cat.is_active == 1 || cat.is_active === '1'
                );

                if (activeCategories.length === 0) {
                    dropdownMenu.innerHTML = '<li><a href="#" class="dropdown-item text-muted">Không có danh mục nào hiển thị</a></li>';
                    return;
                }

                activeCategories.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

                activeCategories.forEach(category => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');

                    a.href = `../../../public/views/client/products.html?category=${category.category_id}`;
                    a.textContent = category.name.trim();
                    a.className = 'dropdown-item';

                    li.appendChild(a);
                    dropdownMenu.appendChild(li);
                });
            } catch (err) {
                console.error('Lỗi load danh mục:', err);
                dropdownMenu.innerHTML = '<li><a href="#" class="dropdown-item text-danger">Lỗi tải danh mục</a></li>';
            }  
            await loadSearchCategories();

            const searchWrap = document.querySelector('.search-dropdown-wrap');
            const searchTrigger = document.querySelector('.search-trigger');
            const searchList = document.getElementById('searchCategoryUl');

            if (searchWrap && searchTrigger && searchList) {
                searchTrigger.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    searchList.classList.toggle('show');
                });

                document.addEventListener('click', (e) => {
                    if (!searchWrap.contains(e.target)) {
                        searchList.classList.remove('show');
                    }
                });
            }
            const btnSearch = document.getElementById('btnSearch');
            const searchInput = document.getElementById('searchInput');

            const performSearch = () => {
                const keyword = searchInput.value.trim();
                const categoryId = document.getElementById('categorySelectValue').value;

                let url = 'products.html';
                const params = new URLSearchParams();

                if (keyword) params.append('q', keyword);
                if (categoryId) params.append('category', categoryId);

                if (params.toString()) url += '?' + params.toString();
                window.location.href = url;
            };

            if (btnSearch) btnSearch.addEventListener('click', performSearch);
            if (searchInput) searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
            updateCartCount();
        });
        function selectSearchCategory(id, name) {
            document.getElementById('categoryDisplayText').innerText = name;
            document.getElementById('categorySelectValue').value = id;

            const searchList = document.getElementById('searchCategoryUl');
            if (searchList) searchList.classList.remove('show');
        }
        async function loadSearchCategories() {
            const ulList = document.getElementById('searchCategoryUl');
            if (!ulList) return;
            ulList.innerHTML = '<li><a href="javascript:void(0)" onclick="selectSearchCategory(\'\', \'Tất cả\')">Tất cả</a></li>';

            try {
                const response = await fetch('../../../api/category/get_category.php@t=' + Date.now());

                if (!response.ok) throw new Error('Lỗi kết nối API');

                const result = await response.json();

                if (result.success && Array.isArray(result.data)) {
                    let categories = result.data;
                    categories.sort((a, b) => a.name.localeCompare(b.name));

                    categories.forEach(category => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = "javascript:void(0)";
                        const catName = category.name.trim();
                        a.textContent = catName;
                        a.onclick = () => selectSearchCategory(category.category_id, catName);

                        li.appendChild(a);
                        ulList.appendChild(li);
                    });
                } else {
                    console.warn("API trả về thành công nhưng không có dữ liệu danh mục nào.");
                }
            } catch (err) {
                console.error('Lỗi load danh mục:', err);
            }
        }
        
         function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const totalItems = cart.length;

            const el = document.getElementById('cartCount');
            if (el) {
                el.textContent = totalItems;
                el.style.display = totalItems > 0 ? 'block' : 'none';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('globalToast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.classList.remove('success', 'error', 'show');

            msg.textContent = message;

            if (type === 'success') {
                toast.classList.add('success');
                icon.className = 'bx bxs-check-circle';
            } else {
                toast.classList.add('error');
                icon.className = 'bx bxs-error';
            }

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
            }, type === 'error' ? 5000 : 3000);
        }
        async function loadFooterNewsCategories() {
            const container = document.getElementById('footerNewsCategories');
            if (!container) return;

            try {
                const res = await fetch('../../../api/news/get_news_categories.php');
                const result = await res.json();

                container.innerHTML = '';

                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(cat => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');

                        a.href = `/public/views/client/news.html?id=${cat.id}`;
                        a.textContent = cat.name;
                        li.appendChild(a);
                        container.appendChild(li);
                    });
                } else {
                    container.innerHTML = '<li class="text-muted small">Chưa có danh mục</li>';
                }
            } catch (err) {
                console.error('Lỗi load danh mục footer:', err);
                container.innerHTML = '<li class="text-danger small">Lỗi tải danh mục</li>';
            }
        }
        async function loadFooterProductsCategories() {
            const container = document.getElementById('footerProductsCategories');
            if (!container) return;

            try {
                const res = await fetch('../../../api/category/get_category.php@t=' + Date.now());
                const result = await res.json();

                container.innerHTML = '';

                if (result.success && Array.isArray(result.data) && result.data.length > 0) {
                    
                    let categories = result.data;
                    categories.sort((a, b) => a.name.localeCompare(b.name));

                    categories.forEach(cat => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `/public/views/client/products.html?category=${cat.category_id}`;
                        a.textContent = cat.name.trim();
                        li.appendChild(a);
                        container.appendChild(li);
                    });
                } else {
                    container.innerHTML = '<li class="text-muted small">Chưa có danh mục</li>';
                }
            } catch (err) {
                console.error('Lỗi load danh mục footer:', err);
                container.innerHTML = '<li class="text-danger small">Lỗi tải danh mục</li>';
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadFooterNewsCategories();
            loadNewsCategoriesDropdown();
            loadFooterProductsCategories();
        });
        async function loadNewsCategoriesDropdown() {
            const dropdown = document.getElementById('newsCategoryDropdown');
            if (!dropdown) return;

            try {
                const res = await fetch('../../../api/news/get_news_categories.php');
                const result = await res.json();

                dropdown.innerHTML = '';

                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(cat => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');

                        a.href = `/public/views/client/news.html?id=${cat.id}`;
                        a.textContent = cat.name;
                        li.appendChild(a);
                        dropdown.appendChild(li);
                    });
                } else {
                    dropdown.innerHTML = '<li class="text-center py-3"><small class="text-muted">Chưa có danh mục tin tức</small></li>';
                }
            } catch (err) {
                console.error('Lỗi load danh mục tin tức:', err);
                dropdown.innerHTML = '<li class="text-center py-3 text-danger"><small>Lỗi tải dữ liệu</small></li>';
            }
        }
    </script>
</body>

</html>